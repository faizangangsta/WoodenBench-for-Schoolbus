<!DOCTYPE HTML>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ç”¨æˆ·ç®¡ç†</title>
<script src="js/Encryption/Base64.js"></script>
<link href="css/font-awesome.min.css" rel="stylesheet" />
<script src="js/jquery-3.2.1.js"></script>
<script src="js/Bootstrap-3.3.7.js"></script>
<script src="js/Encryption/SHAHash.js"></script>
<script src="js/Encryption/MD5.js"></script>
<script src="SchBMgr_js/WeiXinModule.js"></script>
<script src="SchBMgr_js/WCServicesProvider.js"></script>
<link rel="stylesheet" href="css/bootstrap.css">
<link rel="stylesheet" href="css/SchBCSS.css">
<script src="js/CryptoJS/core.js"></script>
<script src="js/CryptoJS/crypto-js.js"></script>
<script src="js/CryptoJS/index.js"></script>
<script src="js/CryptoJS/sha1.js"></script>
<script src="js/CryptoJS/sha256.js"></script>
<script src="js/CryptoJS/x64-core.js"></script>
</head>
<body class="BodyStyle">
<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#defaultNavbar1" aria-expanded="false"> 
		  <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> 
		  <span class="icon-bar"></span> 
		  <span class="icon-bar"></span> 
	  </button>
      <a class="navbar-brand" href="index.html" id="PgTitleBar">ğŸ å›ä¸»é¡µ</a> </div>
    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="defaultNavbar1">
      <ul class="nav navbar-nav">
        <li><a href="index.html">æ¦‚è¿°</a> </li>
        <li><a href="report.html">æ±‡æŠ¥é—®é¢˜</a> </li>
        <li><a href="#">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</a> </li>
        <li class="active"><a href="usermanage.html">ç”¨æˆ·ç®¡ç†</a> </li>
        <li><a href="RptBug.html">åé¦ˆBug</a> </li>
        <li><a href="" id="navUsrName" onclick="RemoveLoginData()">æ³¨é”€å½“å‰è´¦æˆ·</a> </li>
      </ul>
    </div>
  </div>
</nav>
<h4 id="ProcInfo" style="text-align: center; text-decoration-style: double; color: red;"></h4>
<br>
<div class="container">
  <div class="container">
    <label>å½“å‰ç™»é™†ç”¨æˆ·</label>
    <label id="CUserRName">åŠ è½½ä¸­...</label>
    <br>
    <label>å½“å‰ç»‘å®šçš„å¾®ä¿¡å·</label>
    <label id="CUserWCharID">åŠ è½½ä¸­...</label>
  </div>
  <hr>
  <div class="container">
    <label>ç»‘å®šå½“å‰çš„å¾®ä¿¡å·</label>
    <br>
    <div class="container">
      <p id="bongdingInfo">(ç»‘å®šåå¯ä»¥ä½¿ç”¨å¾®ä¿¡ç™»å½•)</p>
      <button type="button" id="bongdingWCBtn" class="btn btn-sm btn-default" onclick="JumpToWeChatLogin('bonding');">ç»‘å®šå½“å‰å¾®ä¿¡å·</button>
      <button type="button" id="UbongdingWCBtn" class="btn btn-sm btn-danger" onclick="UBondingCheck();" style="display: none">è§£ç»‘å¾®ä¿¡å·</button>
    </div>
  </div>
  <hr>
  <div class="container">
    <label>ä¿®æ”¹å¯†ç </label>
    <br>
    <div class="container">
      <p id="ChangPsWdLabel" style="margin-bottom: 5px">ç‚¹å‡»æŒ‰é’®ä¿®æ”¹å¯†ç ï¼š
        <button type="button" class="btn btn-sm btn-default" id="ChangePsBtn" onclick="ReDirectToLogin('usermanage.html?ChangePwd=', '?ChangePassword=RemoteRtn');">ä¿®æ”¹å¯†ç </button>
      </p>
      <div id="NewPs" class="text-center" style="display: none">
        <input class="TxBox" style="display: block;" value="" id="NPsW1" type="password" placeholder="è¾“å…¥æ–°å¯†ç " />
        <input class="TxBox" style="display: block;" value="" id="NPsW2" type="password" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " />
        <button type="button" class="btn btn-sm btn-default" style="margin-top: 8px; width: 60%" onclick="DoChangePsWd();">æäº¤</button>
      </div>
    </div>
  </div>
  <hr>
  <div class="container">
    <label>æ³¨é”€å½“å‰è´¦æˆ·</label>
    <br>
    <div class="container">
      <p>ç‚¹å‡»æŒ‰é’®æ³¨é”€å½“å‰ç”¨æˆ·ï¼š</p>
      <button style="width: 100%" onclick="if (confirm('ç¡®å®šè¦é€€å‡ºå½“å‰ç”¨æˆ·å—ï¼Ÿ'))  { RemoveLoginData(true); location.href = 'index.html' }" class="btn btn-sm btn-danger">é€€å‡ºå½“å‰ç”¨æˆ·</button>
    </div>
  </div>
</div>
	<div class="xnav" style="font-size: 11px">Woodenbench for Schoolbus 2017-2018</div>
<script>
	var currentUser;
	Maininit("usermanage.html", mainInitCallback);
	InitWeixin();
	$("#NPsW1").keydown(function (e)
	{
		if(e.keyCode === 13) DoChangePsWd();
	});
	$("#NPSW2").keydown(function (e)
	{
		if(e.keyCode === 13) DoChangePsWd();
	});

	function ReloadUsrData()
	{
		if(currentUser[6] !== "####")
		{
			$("#CUserWCharID").text(currentUser[6]);
			$("#bongdingWCBtn").hide();
			$("#UbongdingWCBtn").show();
			$("#bongdingInfo").text("ä½ å·²ç»ç»‘å®šäº†å¾®ä¿¡å·ï¼Œç‚¹å‡»æŒ‰é’®è§£ç»‘");
		}
		else
		{
			$("#CUserWCharID").text("æ²¡æœ‰ç»‘å®šå¾®ä¿¡è´¦å·");
			$("#bongdingInfo").text("(ç»‘å®šåå¯ä»¥ä½¿ç”¨å¾®ä¿¡ç™»å½•)");
			$("#bongdingWCBtn").show();
			$("#UbongdingWCBtn").hide();
		}
	}

	function UBondingCheck()
	{
		if(confirm("ç¡®å®šè¦è§£é™¤ç»‘å®šå¾®ä¿¡è´¦å·å—ï¼Ÿ"))
		{
			ReDirectToLogin('usermanage.html?UnBonding=', '?UnBonding=force');
		}
	}

	function mainInitCallback(cUser)
	{
		currentUser = cUser;
		$("#navUsrName").text("æ³¨é”€å½“å‰è´¦æˆ·  -  " + currentUser[8]);
		$("#CUserRName").text(currentUser[8]);
		ReloadUsrData();
		
		///WeChat Bonding and unBonding User
		if(location.href.indexOf("?userid=") > -1)
		{
			var WXUserid = GetURLOption("userid");
			if(WXUserid === "nullStr") location.href = "usermanage.html";
			var TS = GetURLOption("OAuthCallBack");
			var TSSec = getCookie("OAuthCallBack");
			setCookie("OAuthCallBack", "nothing", 5);
			if(TS === TSSec)
			{
				WriteUserData(currentUser[1], "WeChatID", WXUserid, currentUser[2], function (Result)
				{
					if(Result !== false && Result.ErrCode === "0" && Result.ErrMessage === "null")
					{
						currentUser = Result;
						$("#ProcInfo").text("ç»‘å®šæˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨å¾®ä¿¡ç™»é™†");
					}
					else
					{
						$("#ProcInfo").text("ç»‘å®šå¤±è´¥ï¼Œå¦‚æœ‰é—®é¢˜åˆ°èœå•é‡Œé¢æ±‡æŠ¥é—®é¢˜");
					}
					ReloadUsrData();
				});
			}
			else
			{
				location.href = "usermanage.html";
			}
		}
		else if(location.href.indexOf("UnBonding") > -1)
		{
			var TSb = base64decode(utf8to16De(GetURLOption("Option")));
			var TSb2 =getCookie("UBTimeStamp");
			if((TSb === TSb2) && (GetURLOption("UnBonding") === "true"))
			{
				setCookie("UBTimeStamp", "Null TimeStamp");
				WriteUserData(currentUser[1], "WeChatID", "null", currentUser[2], function (Result)
				{
					if(Result !== false && Result.ErrCode === "0" && Result.ErrMessage === "null")
					{
						currentUser = Result;
						$("#ProcInfo").text("è§£é™¤ç»‘å®šæˆåŠŸ");
					}
					else
					{
						$("#ProcInfo").text("è§£é™¤ç»‘å®šå¤±è´¥ï¼Œå¦‚æœ‰é—®é¢˜åˆ°èœå•é‡Œé¢æ±‡æŠ¥é—®é¢˜");
					}
					ReloadUsrData();
				});
			}
			else
			{
				location.href = "usermanage.html";
			}
		}
		else if(location.href.indexOf("ChangePwd") > -1)
		{
			var TSc = base64decode(utf8to16De(GetURLOption("Option")));
			var TSc2 = getCookie("UBTimeStamp");
			if((TSc === TSc2) && (GetURLOption("ChangePwd") === "Allowed"))
			{
				$("#ChangePsBtn").hide();
				$("#ChangPsWdLabel").text("åœ¨ä¸‹é¢è¾“å…¥ä½ çš„å¯†ç ï¼Œç„¶åæŒ‰ç¡®å®š")
				$("#NewPs").show();
				setCookie("UBTimeStamp", "Null TimeStamp");
			}
			else
			{
				location.href = "usermanage.html";
			}
		}
	}

	function DoChangePsWd()
	{
		var Ps1 = $("#NPsW1").val();
		var Ps2 = $("#NPsW2").val();
		if((Ps1 === "") || (Ps2 === ""))
		{
			$("#ProcInfo").text("æ–°å¯†ç ä¸èƒ½ä¸ºç©º");
		}
		else if(Ps1 !== Ps2)
		{
			$("#ProcInfo").text("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸åŒ¹é…ï¼Œè¯·å†è¯•ä¸€éï¼Œå¦‚æœ‰é—®é¢˜åˆ°èœå•é‡Œé¢æ±‡æŠ¥é—®é¢˜");
		}
		else if((Ps1 !== "") && (Ps2 !== "") && (Ps1 === Ps2))
		{
			WriteUserData(currentUser[1], "Password", CryptoJS.SHA256(Ps1).toString(), currentUser[2], function (Result)
			{
				if(Result !== false)
				{
					$("#ProcInfo").text("ä¿®æ”¹å¯†ç æˆåŠŸï¼Œä¸‹æ¬¡éœ€è¦ä½¿ç”¨æ–°å¯†ç ç™»å½•");
					currentUser = Result;						
				}
				else $("#ProcInfo").text("å‡ºç°é—®é¢˜ï¼Œå¦‚æœ‰é—®é¢˜åˆ°èœå•é‡Œé¢æ±‡æŠ¥é—®é¢˜");
			});
		}
	}
	</script>
</body>
</html>
