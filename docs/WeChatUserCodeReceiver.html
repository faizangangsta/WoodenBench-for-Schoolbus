<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
    <title>使用微信账号登录</title>
    <script src="js/bmob.js"></script>
    <script src="js/Encryption/Cookie.js"></script>
    <script src="js/Encryption/Base64.js"></script>
    <script src="js/jquery-3.2.1.js"></script>
    <script src="js/Bootstrap-3.3.7.js"></script>
    <script src="js/Encryption/SHAHash.js"></script>
    <script src="js/Encryption/MD5.js"></script>
    <script src="SchBMgr_js/SecKeyMgr.js"></script>
    <script src="SchBMgr_js/WeiXinModule.js"></script>
    <script src="SchBMgr_js/SCHLoginServices.js"></script>
    <script src="SchBMgr_js/GlobalFunctions.js"></script>
    <script src="SchBMgr_js/WCServicesProvider.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="SchBCSS.css">
    <style>
        .box1 {
            float: left;
            display: inline;
        }

        .box2 {
            float: left;
            display: inline;
        }

        .halfWidth {
            width: 48%;
        }

        .halfWidthR {
            margin-left: 4%;
            width: 48%;
        }
    </style>
</head>
<body class="BodyStyle">
<div>
    <div id="mainlogin" class="container-fluid" style="text-align: center; display: none;">
        <h3>使用微信账号登录</h3>
        <br>
        <h4>您将要使用以下账户登录</h4>
        <h4>小板凳</h4>
        <div class="container-fluid pop-box">
            <div class="container-fluid">
                <h4>使用以下微信号</h4>
                <br>
                <img src="" id="UsrHeadImg" style="width: 40%;"/>
                <br>
                <table class="container-fluid text-center" border="0">
                    <tbody>
                    <tr>
                        <td style="width: 35%;">
                            <h4>用户ID</h4>
                        </td>
                        <td style="width: 30%;">

                        </td>
                        <td style="width: 35%;">
                            <h4>姓名</h4>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <h5 id="UserIDa">&nbsp;</h5>
                            <br>
                        </td>
                        <td></td>
                        <td>
                            <h5 id="RealNamea">&nbsp;</h5>
                            <br>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <br>
        <div class="container-fluid">
            <input class="btn btn-danger box1 halfWidth"
                   type="button" onclick="CancelLogin();" value="取消"/>
            <input class="btn btn-success box2 halfWidthR"
                   type="button" onclick="DoLogin();" value="确定"/>
        </div>
    </div>
    <div id="mainloginfailed" class="container-fluid" style="margin-top: 30px; text-align: center; display: none">
        <h3 id="faileddetail" style="word-break: break-all;width: 90%;"></h3>
        <br>
        <input class="btn btn-danger" style="width: 80%;" type="button"
               onclick="CancelLogin();" value="返回"/>
    </div>
</div>
<script>
    window.history.forward(1);
    Bmob.initialize("b770100ff0051b0c313c1a0e975711e6", "281fb4c79c3a3391ae6764fa56d1468d");
    var currentWXUser;
    InitWeixin();
    wx.ready(function () { wx.hideOptionMenu(); });


    function ShowUserBasicData(UserData)
    {
        currentWXUser = JSON.parse(UserData);
        document.getElementById('mainlogin').style.display = 'block';
        document.getElementById("UsrHeadImg").src = currentWXUser["avatar"];
        $("#UserIDa").text(currentWXUser["userid"]);
        $("#RealNamea").text(currentWXUser["name"]);
    }

    var TimeStamp = base64decode(utf8to16De(getSecKey("WCLogin")));
    if (TimeStamp === GetURLOption("state"))
    {
        var UsrCode = GetURLOption("code");
        GetUserData(UsrCode, ShowUserBasicData);
    }
    else
    {
        document.getElementById('mainloginfailed').style.display = 'block';
        $("#faileddetail").text("没能获取到你的信息，过会再试试吧");
    }

    function DoLogin()
    {
        var TS;
        var AuthMode = TimeStamp.split(";")[1];
        if (AuthMode === "bonding")
        {
            TS = new Date().getTime().toString();
            setSecKey("OAuthCallBack", TS, 60);
            location.href = "usermanage.html?userid=" + currentWXUser["userid"] + "&OAuthCallBack=" + TS;
        }
        else if (AuthMode === "oauthlogin")
        {
            TS = new Date().getTime().toString();
            setSecKey("OAuthCallBack", TS, 60);
            location.href = "loginusr.html?userid=" + currentWXUser["userid"] + "&OAuthCallBack=" + TS;
        }
    }

    function CancelLogin()
    {

        location.href = getCookie("SBCallBackAddress");
    }
</script>
</body>
</html>