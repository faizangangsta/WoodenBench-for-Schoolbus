<!DOCTYPE html>
<html lang="cn">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>管理页面登录</title>
    <script src="js/bmob.js"></script>
    <script src="js/Encryption/Base64.js"></script>
    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/Encryption/SHAHash.js"></script>
    <script src="js/Encryption/MD5.js"></script>
    <script src="SchBMgr_js/WeiXinModule.js"></script>
    <script src="SchBMgr_js/WCServicesProvider.js"></script>
    <link href="css/WBWeb.css" rel="stylesheet" />
    <link href="css/bootstrap.css" rel="stylesheet" />
    <script src="js/CryptoJS/core.js"></script>
    <script src="js/CryptoJS/crypto-js.js"></script>
    <script src="js/CryptoJS/index.js"></script>
    <script src="js/CryptoJS/x64-core.js"></script>
</head>
<body style="background-image: url('Backgrounds/back1.jpg');">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header"> <a class="navbar-brand" href="loginusr.html" id="PgTitleBar">登录</a> </div>
        </div>
    </nav>
    <div class="container GWhite">
        <h3 id="BigTitleTop">管理页面登录</h3>
        <h5 id="StaNotificaiton">&nbsp;</h5>
        <hr>
        <h4 id="faileddetail" class="container" style="word-break: break-all;width: 90%;">请输入用户名和密码</h4>
        <hr>
        <div class="container-fluid" id="loginfield">
            <div id="WCLogin">
                <span>或者使用</span>
                <button class="btn btn-sm btn-default" onclick="JumpToWeChatLogin('oauthlogin')">微信登录</button>
                <span>*此功能只能在绑定后使用</span> <br>
            </div>
            <h4>用户名</h4>
            <input class="text-center TxBox" id="UsrNameTx">
            <br>
            <h4>密码</h4>
            <input type="password" class="text-center TxBox" id="PsWdTx">
            <br>
            <button id="LGBtn" class="TxBox" style="width: 60%;margin: 0 auto;" onclick="DoLoginCheck(document.getElementById('UsrNameTx').value,CryptoJS.SHA256(document.getElementById('PsWdTx').value));">登录</button>
        </div>
        <div id="loginfailed" class="container-fluid" style="margin-top: 30px; text-align: center; display: none;">
            <button class="btn btn-danger" style="width: 80%;" type="button" onclick="CancelLogin();">返回</button>
        </div>
    </div>
    <div class="xnav" style="font-size: 11px">Woodenbench for Schoolbus 2017-2018</div>
    <script>
        Bmob.initialize("b770100ff0051b0c313c1a0e975711e6", "281fb4c79c3a3391ae6764fa56d1468d");
        document.getElementById('UsrNameTx').focus();
        InitWeixin();

        function CancelLogin()
        {
            location.href = "usrlogin.html";
        }

        function DoLoginCheck(UserName, PsWd)
        {
            var RandomStr = randomString(32);
            setCookie("SecretKey", RandomStr);
            var p = CryptoJS.SHA256(PsWd + RandomStr);
            $.ajax(
                {
                    url: "https://api.lhy0403.top/api/usr_Login?PasswordHASH=" + p + "&UserName=" + UserName + "&SALT=" + RandomStr,
                    type: 'GET',
                    dataType: 'JSONP',
                    success: function (data)
                    {
                        RandomStr = "";
                        if (data.ErrCode === "0")
                        {
                            ProcLogin(data);
                        }
                        else
                        {
                            $("#faileddetail").text("登陆失败，用户名或密码不正确");
                        }
                    },
                    error: function (err)
                    {
                        RandomStr = "";
                        $("#faileddetail").text("出现了一些问题");
                    }
                });
            RandomStr = "";
        }

        $('#UsrNameTx').keydown(function (e)
        {
            if (e.keyCode === 13) DoLoginCheck(document.getElementById('UsrNameTx').value, CryptoJS.SHA256(document.getElementById("PsWdTx").value));
            else $("#faileddetail").text("请输入用户名和密码");
        });

        $('#PsWdTx').keydown(function (e)
        {
            if (e.keyCode === 13) DoLoginCheck(document.getElementById('UsrNameTx').value, CryptoJS.SHA256(document.getElementById("PsWdTx").value));
            else $("#faileddetail").text("请输入用户名和密码");
        });

        if (location.href.indexOf("?userid=") > -1)
        {
            var WXUserid;
            $("#loginfield").remove();
            WXUserid = GetURLOption("userid");
            if (WXUserid === "nullStr") location.href = "usrlogin.html";
            var TS = GetURLOption("OAuthCallBack");
            var TSSec = getCookie("OAuthCallBack");
            setCookie("OAuthCallBack", "nothing", 2);

            if (TS === TSSec)
            {
                $("#faileddetail").text("正在登录……");
                $.ajax(
                    {
                        url: "https://api.lhy0403.top/api/usr_Query?ColName=WeChatID&EqualsTo=" + WXUserid,
                        type: 'GET',
                        dataType: 'JSONP',
                        success: function (data)
                        {
                            if (data.ErrCode === "0")
                            {
                                if (data.count === "0")
                                {
                                    $("#faileddetail").text("目前没有人绑定这个微信号啊");
                                    $("#loginfailed").show();
                                }
                                else
                                {
                                    var tmp = JSON.parse(data.num_0);
                                    if (tmp.FirstLogin.toLowerCase() === "true")
                                    {
                                        $("#WCLogin").remove();
                                        $("#StaNotificaiton").html("这是你第一次使用新密码登录。<br>为了不忘记新密码，你暂时不能使用微信登陆");
                                        $("#faileddetail").text("请使用用户名和密码登录");
                                        $("#loginfailed").show();
                                    }
                                    else
                                    {
                                        DoLoginCheck(tmp.Username, tmp.Password);
                                    }
                                }
                            }
                            else
                            {
                                $("#faileddetail").html("暂时无法使用微信登录，过会再试试？<br>" + data.ErrMessage);
                                $("#loginfailed").show();
                            }
                        },
                        error: function (err)
                        {
                            $("#faileddetail").html("暂时无法使用微信登录，过会再试试？<br>" + data.ErrMessage);
                            $("#loginfailed").show();
                        }

                    });
            }
            else
            {
                $("#faileddetail").text("请求时出现问题，返回重试一下?");
                $("#loginfailed").show();
            }
        }
        else if (location.href.indexOf("UnBonding=force") > -1)
        {
            var UsrConfig = getCookie("SBUser_Data");
            $("#UsrNameTx").attr("disabled", true);
            $("#UsrNameTx").val((UsrConfig.split(";"))[1]);
            $("#BigTitleTop").text("重新输入密码来解除绑定");
            $("#StaNotificaiton").text("解除绑定之后，你只能用账号和密码登陆");
            $("#WCLogin").remove();
        }
        else if (location.href.indexOf("ChangePassword") > -1)
        {
            var UsrConfig = getCookie("SBUser_Data");
            $("#UsrNameTx").attr("disabled", true);
            $("#UsrNameTx").val((UsrConfig.split(";"))[1]);
            $("#BigTitleTop").text("请输入当前的密码");
            $("#StaNotificaiton").text("");
            $("#WCLogin").remove();
        }
    </script>
</body>
</html>
